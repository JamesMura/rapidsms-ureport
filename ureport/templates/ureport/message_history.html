{% extends "layout.html" %}
{% block title %}
    Ureport Messaging History - {{ block.super }}
{% endblock %}
{% block stylesheets %}
    {{ block.super }}
    <link type="text/css" rel="stylesheet" href="{{MEDIA_URL}}ureport/css/jquery-ui.css"/>
    <link type="text/css" rel="stylesheet" href="{{MEDIA_URL}}ureport/css/message_history.css"/>
{% endblock %}
{% block javascripts %}
    {{ block.super }}
    <script src="{{MEDIA_URL}}ureport/javascripts/jquery-ui.js" type="text/javascript"></script>
    <script src="{{MEDIA_URL}}ureport/javascripts/ureport.js" type="text/javascript"></script>
{% endblock %}
{% block content %}
{% comment %}
<input type="hidden" name="csrf_token" value="{{ csrf_token|escapejs }}" />
{% endcomment %}
	<div id="msg_history">
        <h2 style="white-space:normal">
            Messaging History for 
            {% if connection.contact %}
            	<span class="message_history_contact">{{ connection.contact }}</span><br />
            	<span class="message_history_stats">Latest Message: {{ stats_latest_message|truncatewords:20 }}</span><br />
            	<span class="message_history_stats">Total Outgoing Messages: {{ stats_total_outgoing }}</span><br />
            	<span class="message_history_stats">Total Incoming Messages: {{ stats_total_incoming }}</span>
            {% else %}
            	<span class="message_history_contact">Annonymous</span>
            {% endif %}
            <img id="collapse_img" style="float:right" src="{{ MEDIA_URL }}rapidsms/icons/silk/section_expanded--bright.png" onclick="collapse()"/>
            <img id="expand_img" style="float:right;display:none" src="{{ MEDIA_URL }}rapidsms/icons/silk/section_collapsed--bright.png" onclick="expand()"/>            
        </h2>
        <br />
        <div id="accordion">
	{% for msg in messages %}
		{% ifequal msg.direction "I" %}
			<h3><a href="#"><img id="collapse_img" style="float:left" src="{{ MEDIA_URL }}rapidsms/icons/silk/phone.png" />
						{% for key, direction in direction_choices %} 
						{% ifequal key msg.direction %} <span class="message_history_incoming"> &raquo;&raquo; </span> {% endifequal %}
						{% endfor %} 
						{{ msg.text|truncatewords:9 }} (from {{ connection.identity }}) 
						<span class="message_history_date">
						(
						{% for key, status in status_choices %} 
						{% ifequal key msg.status %} {{ status }} {% endifequal %}
						{% endfor %}
						) {{ msg.date|date:"D d M Y" }}</span>
						{% for response in msg.responses.all %}
							<br /><span class="message_history_replies">
								{% for key, direction in direction_choices %} 
								{% ifequal key response.direction %} <span class="message_history_outgoing"> &laquo;&laquo; </span> {% endifequal %}
								{% endfor %} 
								{{ response.text|truncatewords:12 }}
							</span>
						{% endfor %}
						</a>
			</h3>
			<div class="message_history_small">
				<p class="message_history_basemessage">
				Message:{{ msg.text }}<br />
				Date:	{{ msg.date|date:"D d M Y" }}<br />
				Status: {% for key, status in status_choices %} 
						{% ifequal key msg.status %} {{ status }} {% endifequal %}
						{% endfor %}
				</p>
				{% for response in msg.responses.all %}
					<p>
					( 
						{% for key, direction in direction_choices %} 
						{% ifequal key response.direction %} {{ direction }} {% endifequal %}
						{% endfor %} 
					) {{ response.text }}<br />
					Date: 	{{ response.date|date:"D d M Y" }}<br />
					Status: {% for key, status in status_choices %} 
						   	{% ifequal key response.status %} {{ status }} {% endifequal %}
						   	{% endfor %}
					</p>
				{% endfor %}
				<div class="message_history_replyForm" id="message_history_replyForm{{ msg.pk }}">
				  	<a href="#" onclick="javascript:toggleReplyBox(this, {{ connection.identity }}, {{ msg.pk }});return false;" class="send_message">- send message -</a>
				  	<div class="replyForm" id="replyForm_{{ msg.pk }}"></div>
				</div>
			</div>
		{% else %}
			{% if not msg.in_response_to %}
				<h3><a href="#"><img id="collapse_img" style="float:left" src="{{ MEDIA_URL }}rapidsms/icons/silk/phone.png" />
							{% for key, direction in direction_choices %} 
							{% ifequal key msg.direction %}<span class="message_history_outgoing"> &laquo;&laquo; </span>{% endifequal %}
							{% endfor %} 
							{{ msg.text|truncatewords:9 }} (to {{ connection.identity }})
							<span class="message_history_date">
							(
							{% for key, status in status_choices %} 
							{% ifequal key msg.status %} {{ status }} {% endifequal %}
							{% endfor %}
							)
							{{ msg.date|date:"D d M Y" }}</span></a></h3>
				<div class="message_history_small">
					<p class="message_history_basemessage">
					Message:{{ msg.text }}<br />
					Date: 	{{ msg.date|date:"D d M Y" }}<br />
					Status:	{% for key, status in status_choices %} 
							{% ifequal key msg.status %} {{ status }} {% endifequal %}
							{% endfor %}
					</p>
				</div>
			{% endif %}
		{% endifequal %}
	{% endfor %}
	</div></div>
	<div id="formcontent" style="display:none">
	<form method="POST" class="sender-form"> {{ replyForm }}<input type="hidden" name="action" value="reply" /><input type="submit" value="send" /><input type="hidden" name="csrfmiddlewaretoken" value="{% with csrf_token as csrf_token_clean %}{{ csrf_token_clean }}{% endwith %}" /></form>
	</div>
{% endblock %}