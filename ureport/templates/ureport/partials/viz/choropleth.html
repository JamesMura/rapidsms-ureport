<div id="map_{{ poll.pk }}" class="mapmodule"  >
</div>
<div id="map_layers">
    <ul class="key">
		<li>No (50-60%)
		   <span style="width: 15px; height: 15px; background-color: #f5cbae; position: absolute; right: 0px;" class="category"></span>
		</li>
		
		<li>No (60-70%)
		   <span style="width: 15px; height: 15px; background-color: #eba988; position: absolute; right: 0px;" class="category"></span>
		</li>
		
		<li>No (70-80%)
		   <span style="width: 15px; height: 15px; background-color: #e08465; position: absolute; right: 0px;" class="category"></span>
		</li>
		
		<li>No (80-90%)
		   <span style="width: 15px; height: 15px; background-color: #d65d45; position: absolute; right: 0px;" class="category"></span>
		</li>
		
		<li>No (90-100%)
		   <span style="width: 15px; height: 15px; background-color: #c40a0a; position: absolute; right: 0px;" class="category"></span>
		</li>
		
		<li>Yes (50-60%)
		   <span style="width: 15px; height: 15px; background-color: #aef5cb; position: absolute; right: 0px;" class="category"></span>
		</li>
		
		<li>Yes (60-70%)
		   <span style="width: 15px; height: 15px; background-color: #88eba9; position: absolute; right: 0px;" class="category"></span>
		</li>
		
		<li>Yes (70-80%)
		   <span style="width: 15px; height: 15px; background-color: #65e084; position: absolute; right: 0px;" class="category"></span>
		</li>
		
		<li>Yes (80-90%)
		   <span style="width: 15px; height: 15px; background-color: #45d65d; position: absolute; right: 0px;" class="category"></span>
		</li>
		
		<li>Yes (90-100%)
		   <span style="width: 15px; height: 15px; background-color: #0ac40a; position: absolute; right: 0px;" class="category"></span>
       	</li>
    </ul>
</div>
 <script defer="defer" type="text/javascript">
            var map;
            var tiled;
            var pureCoverage = false;
            // pink tile avoidance
            OpenLayers.IMAGE_RELOAD_ATTEMPTS = 5;
            OpenLayers.Util.onImageLoadErrorColor = "transparent";
            // make OL compute scale according to WMS spec
            OpenLayers.DOTS_PER_INCH = 25.4 / 0.28;

            function  init_chmap(){
                // if this is just a coverage or a group of them, disable a few items,
                // and default to jpeg format
                format = 'image/png';


                var bounds = new OpenLayers.Bounds(
                    3292022.5, -164636.828,
                    3896216.5, 471764.844
                );
                var options = {
                    controls: [],
                    maxExtent: bounds,
                    maxResolution: 2485.94403125,
                    projection: new OpenLayers.Projection("EPSG:900913"),
                    displayProjection: new OpenLayers.Projection("EPSG:4326"),
                    units: "m",
                    numZoomLevels: 20,

                };
                map = new OpenLayers.Map('map_{{ poll.pk }}', options);

                // setup tiled layer
                tiled = new OpenLayers.Layer.WMS(
                    "unicef:polls", "http://ureport.ug:80/geoserver/unicef/wms",
                    {
                        VIEWPARAMS: 'poll:{{poll.pk}};app:{{deployment_id}}',
                        LAYERS: 'unicef:polls',
                        STYLES: '',
                        format: format,
                        tiled: true,
                        transparent:true,
                        tilesOrigin : map.maxExtent.left + ',' + map.maxExtent.bottom
                    },
                    {
                        buffer: 0,
                        displayOutsideMaxExtent: false,
                        isBaseLayer: false,
                        'opacity': 1.0,
                    }
                );
                var ghyb = new OpenLayers.Layer.Google(
        "Google RoadMap",
        {type: google.maps.MapTypeId.ROADMAP, numZoomLevels: 20}
    );

                map.addLayers([ ghyb,tiled ]);

                // build up all controls
                map.addControl(new OpenLayers.Control.PanZoomBar({
                    position: new OpenLayers.Pixel(2, 15)
                }));
                map.addControl(new OpenLayers.Control.Navigation());
                map.addControl(new OpenLayers.Control.LayerSwitcher());
                map.zoomToExtent(bounds);



                // support GetFeatureInfo
                map.events.register('click', map, function (e) {
                    document.getElementById('nodelist').innerHTML = "Loading... please wait...";
                    var params = {
                        REQUEST: "GetFeatureInfo",
                        EXCEPTIONS: "application/vnd.ogc.se_xml",
                        BBOX: map.getExtent().toBBOX(),
                        SERVICE: "WMS",
                        VERSION: "1.1.1",
                        X: e.xy.x,
                        Y: e.xy.y,
                        INFO_FORMAT: 'text/html',
                        QUERY_LAYERS: 'unicef:polls',
                        FEATURE_COUNT: 50,
                        Viewparams: 'poll:{{poll.pk}};app:{{deployment_id}}',
                        Layers: 'unicef:polls',
                        WIDTH: map.size.w,
                        HEIGHT: map.size.h,
                        format: format,
                        styles: '',
                        srs: "EPSG:900913"};
                    if(map.layers[1].params.CQL_FILTER != null) {
                        params.cql_filter = map.layers[0].params.CQL_FILTER;
                    }
                    if(map.layers[1].params.FILTER != null) {
                        params.filter = map.layers[0].params.FILTER;
                    }
                    if(map.layers[1].params.FEATUREID) {
                        params.featureid = map.layers[0].params.FEATUREID;
                    }
                    OpenLayers.loadURL("http://ureport.ug:80/geoserver/unicef/wms", params, this, setHTML);
                    OpenLayers.Event.stop(e);
                });
            }

            // sets the HTML provided into the nodelist element
            function setHTML(response){
                document.getElementById('nodelist').innerHTML = response.responseText;

            };
    $(document).ready(function() {
        init_chmap();
        CATEGORY_COLORS =  {% autoescape off %}{{ colors }}{% endautoescape %};
        CATEGORY_COLOR_LOOKUP['no'] = '#AA4643';
        CATEGORY_COLOR_LOOKUP['yes'] = '#89A54E';
        CATEGORY_COLOR_LOOKUP['unknown'] = '#80699B';
        CATEGORY_COLOR_LOOKUP['uncategorized'] = '#4572A7';
        CATEGORY_OFFSET = 4;
    });
</script>

